// Generated by CoffeeScript 1.3.3
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Kona.ready(function() {
  var Coin, DirtTile, Enemy, EnemyPistol, EnemyProj, Pistol, PistolProj, Player, level1_1, level1_2, player;
  Kona.Canvas.init('canvas');
  Kona.Sounds.load({
    'fire': 'audio/enemy_fire.ogg'
  });
  level1_1 = new Kona.Scene({
    name: 'lvl1:s1',
    background: 'img/backgrounds/lvl2.jpg',
    active: true
  });
  level1_2 = new Kona.Scene({
    name: 'lvl1:s2',
    background: 'img/backgrounds/lvl2.jpg'
  });
  DirtTile = (function(_super) {

    __extends(DirtTile, _super);

    function DirtTile() {
      return DirtTile.__super__.constructor.apply(this, arguments);
    }

    return DirtTile;

  })(Kona.Tile);
  Player = (function(_super) {

    __extends(Player, _super);

    function Player(opts) {
      if (opts == null) {
        opts = {};
      }
      Player.__super__.constructor.call(this, opts);
      this.speed = 2;
      this.jumpHeight = 12;
      this.jumpDuration = 180;
      this.isJumping = false;
      this.facing = '';
      this.canFire = false;
      this.currentWeapon = null;
      this.collects('coins', 'weapons');
    }

    Player.prototype.update = function() {
      Player.__super__.update.call(this);
      if (this.isJumping) {
        this.position.y -= this.jumpHeight;
        this.correctTop();
      } else {
        this.addGravity();
      }
      if (this.top() > Kona.Canvas.height) {
        this.die();
      }
      if (this.right() > Kona.Canvas.width - 20) {
        Kona.Scenes.nextScene();
        Kona.Scenes.currentScene.addEntity(player);
        return this.setPosition(0, this.top());
      }
    };

    Player.prototype.stop = function(axis) {
      this.setAnimation('idle');
      this.facing = '';
      return Player.__super__.stop.call(this, axis);
    };

    Player.prototype.setDirection = function(dir) {
      this.setAnimation("run_" + dir);
      return this.direction.dx = dir === 'left' ? -1 : 1;
    };

    Player.prototype.jump = function() {
      var _this = this;
      if (!this.isJumping && this.onSurface()) {
        this.isJumping = true;
        this.position.y -= 20;
        return setTimeout(function() {
          _this.isJumping = false;
          if (_this.facing !== '') {
            return _this.setAnimation("run_" + _this.facing);
          }
        }, this.jumpDuration);
      }
    };

    Player.prototype.fire = function() {
      if (this.currentWeapon != null) {
        return this.currentWeapon.fire();
      }
    };

    Player.prototype.die = function() {
      var _this = this;
      return setTimeout(function() {
        _this.facing = 'right';
        return _this.setPosition(195, 200);
      }, 400);
    };

    return Player;

  })(Kona.Entity);
  Enemy = (function(_super) {

    __extends(Enemy, _super);

    function Enemy(opts) {
      if (opts == null) {
        opts = {};
      }
      Enemy.__super__.constructor.call(this, opts);
      this.currentWeapon = new EnemyPistol({
        group: 'enemy_weapons',
        holder: this
      });
      level1_1.addEntity(this.currentWeapon);
    }

    Enemy.prototype.update = function() {
      Enemy.__super__.update.apply(this, arguments);
      return this.addGravity();
    };

    Enemy.prototype.destroy = function() {
      this.currentWeapon.destroy();
      return Enemy.__super__.destroy.apply(this, arguments);
    };

    return Enemy;

  })(Kona.Entity);
  Coin = (function(_super) {

    __extends(Coin, _super);

    function Coin() {
      return Coin.__super__.constructor.apply(this, arguments);
    }

    Coin.prototype.activate = function(collector) {
      return puts("Coin activated!");
    };

    return Coin;

  })(Kona.Collectable);
  Pistol = (function(_super) {

    __extends(Pistol, _super);

    function Pistol(opts) {
      if (opts == null) {
        opts = {};
      }
      Pistol.__super__.constructor.call(this, opts);
      this.recharge = 150;
      this.projType = PistolProj;
      this.projSound = 'fire';
    }

    return Pistol;

  })(Kona.Weapon);
  PistolProj = (function(_super) {

    __extends(PistolProj, _super);

    function PistolProj(opts) {
      if (opts == null) {
        opts = {};
      }
      PistolProj.__super__.constructor.call(this, opts);
      this.destructibles = ['enemies'];
      this.box = {
        width: 15,
        height: 10
      };
    }

    PistolProj.prototype.draw = function() {
      var _this = this;
      return Kona.Canvas.safe(function() {
        Kona.Canvas.ctx.fillStyle = 'blue';
        return Kona.Canvas.ctx.fillRect(_this.position.x, _this.position.y, _this.box.width, _this.box.height);
      });
    };

    return PistolProj;

  })(Kona.Projectile);
  EnemyProj = (function(_super) {

    __extends(EnemyProj, _super);

    function EnemyProj(opts) {
      if (opts == null) {
        opts = {};
      }
      EnemyProj.__super__.constructor.call(this, opts);
      this.destructibles = [];
    }

    return EnemyProj;

  })(PistolProj);
  EnemyPistol = (function(_super) {

    __extends(EnemyPistol, _super);

    function EnemyPistol(opts) {
      var _this = this;
      if (opts == null) {
        opts = {};
      }
      EnemyPistol.__super__.constructor.call(this, opts);
      this.targets = ['player'];
      this.recharge = 1000;
      this.projType = EnemyProj;
      setInterval(function() {
        return _this.fire();
      }, this.recharge);
    }

    EnemyPistol.prototype.draw = function() {
      var _this = this;
      return Kona.Canvas.safe(function() {
        Kona.Canvas.ctx.fillStyle = 'red';
        return Kona.Canvas.ctx.fillRect(_this.position.x, _this.position.y, _this.box.width, _this.box.height);
      });
    };

    return EnemyPistol;

  })(Kona.EnemyWeapon);
  player = new Player({
    x: 200,
    y: 200,
    width: 64,
    height: 64,
    color: 'black',
    group: 'player'
  });
  player.loadAnimations({
    'idle': {
      sheet: 'img/entities/monster_idle.png'
    },
    'run_left': {
      sheet: 'img/entities/monster_run_left.png'
    },
    'run_right': {
      sheet: 'img/entities/monster_run_right.png'
    }
  });
  player.setAnimation('idle');
  level1_1.addEntity(player);
  Kona.Keys.keydown = function(key) {
    switch (key) {
      case 'left':
        return player.setDirection('left');
      case 'right':
        return player.setDirection('right');
      case 'up':
        return player.jump();
      case 'space':
        return player.fire();
    }
  };
  Kona.Keys.keyup = function(key) {
    switch (key) {
      case 'left':
      case 'right':
        return player.stop('dx');
      case 'up':
      case 'down':
        return player.stop('dy');
    }
  };
  Kona.Scenes.definitionMap = {
    '-': {
      group: 'tiles',
      klass: Kona.BlankTile
    },
    'r': {
      group: 'tiles',
      klass: DirtTile,
      opts: {
        sprite: 'img/tiles/dirt1.png'
      }
    },
    'o': {
      group: 'tiles',
      klass: DirtTile,
      opts: {
        sprite: 'img/tiles/dirt1.png'
      }
    },
    'b': {
      group: 'tiles',
      klass: DirtTile,
      opts: {
        sprite: 'img/tiles/dirt1.png'
      }
    },
    'x': {
      group: 'enemies',
      klass: Enemy,
      opts: {
        width: 40,
        height: 60,
        offset: {
          x: 15
        },
        sprite: 'img/entities/ninja1.png'
      }
    },
    'c': {
      group: 'coins',
      klass: Coin,
      opts: {
        width: 25,
        height: 25,
        offset: {
          x: 20,
          y: 20
        },
        sprite: 'img/powerups/coin.png'
      }
    },
    'p': {
      group: 'weapons',
      klass: Pistol,
      opts: {
        width: 50,
        height: 25,
        offset: {
          x: 15,
          y: 15
        },
        sprite: 'img/weapons/pistol.png'
      }
    }
  };
  level1_1.loadEntities([['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', '-', '-', '-', '-', 'o', 'b'], ['r', 'b', '-', '-', '-', '-', '-', '-', 'r', '-', '-'], ['o', '-', '-', '-', '-', '-', '-', 'x', '-', '-', '-'], ['r', 'c', 'c', 'o', 'p', '-', 'b', 'o', '-', '-', '-'], ['b', 'o', 'r', 'b', 'r', '-', '-', 'r', 'o', '-', 'r']]);
  level1_2.loadEntities([['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', '-', '-', '-', '-', '-', '-'], ['b', 'r', 'o', '-', '-', '-', '-', '-', '-', '-', '-'], ['-', '-', '-', '-', '-', 'r', 'r', 'r', '-', '-', '-'], ['-', '-', '-', '-', 'r', 'r', '-', '-', '-', '-', '-'], ['-', '-', '-', 'r', 'r', 'c', '-', '-', '-', 'r', 'r'], ['o', 'b', '-', 'r', 'r', 'r', 'r', 'r', 'r', 'r', 'r']]);
  return Kona.Engine.start();
});
