(function(){var t=this,n=t._,e={},i=Array.prototype,r=Object.prototype,o=Function.prototype,u=i.push,s=i.slice,a=i.concat,l=r.toString,c=r.hasOwnProperty,h=i.forEach,p=i.map,f=i.reduce,d=i.reduceRight,y=i.filter,m=i.every,g=i.some,v=i.indexOf,x=i.lastIndexOf,w=Array.isArray,K=Object.keys,_=o.bind,b=function(t){return t instanceof b?t:this instanceof b?(this._wrapped=t,void 0):new b(t)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports._=b):t._=b,b.VERSION="1.4.3";var S=b.each=b.forEach=function(t,n,i){if(null!=t)if(h&&t.forEach===h)t.forEach(n,i);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(n.call(i,t[r],r,t)===e)return}else for(var u in t)if(b.has(t,u)&&n.call(i,t[u],u,t)===e)return};b.map=b.collect=function(t,n,e){var i=[];return null==t?i:p&&t.map===p?t.map(n,e):(S(t,function(t,r,o){i[i.length]=n.call(e,t,r,o)}),i)};var C="Reduce of empty array with no initial value";b.reduce=b.foldl=b.inject=function(t,n,e,i){var r=arguments.length>2;if(null==t&&(t=[]),f&&t.reduce===f)return i&&(n=b.bind(n,i)),r?t.reduce(n,e):t.reduce(n);if(S(t,function(t,o,u){r?e=n.call(i,e,t,o,u):(e=t,r=!0)}),!r)throw new TypeError(C);return e},b.reduceRight=b.foldr=function(t,n,e,i){var r=arguments.length>2;if(null==t&&(t=[]),d&&t.reduceRight===d)return i&&(n=b.bind(n,i)),r?t.reduceRight(n,e):t.reduceRight(n);var o=t.length;if(o!==+o){var u=b.keys(t);o=u.length}if(S(t,function(s,a,l){a=u?u[--o]:--o,r?e=n.call(i,e,t[a],a,l):(e=t[a],r=!0)}),!r)throw new TypeError(C);return e},b.find=b.detect=function(t,n,e){var i;return E(t,function(t,r,o){return n.call(e,t,r,o)?(i=t,!0):void 0}),i},b.filter=b.select=function(t,n,e){var i=[];return null==t?i:y&&t.filter===y?t.filter(n,e):(S(t,function(t,r,o){n.call(e,t,r,o)&&(i[i.length]=t)}),i)},b.reject=function(t,n,e){return b.filter(t,function(t,i,r){return!n.call(e,t,i,r)},e)},b.every=b.all=function(t,n,i){n||(n=b.identity);var r=!0;return null==t?r:m&&t.every===m?t.every(n,i):(S(t,function(t,o,u){return(r=r&&n.call(i,t,o,u))?void 0:e}),!!r)};var E=b.some=b.any=function(t,n,i){n||(n=b.identity);var r=!1;return null==t?r:g&&t.some===g?t.some(n,i):(S(t,function(t,o,u){return r||(r=n.call(i,t,o,u))?e:void 0}),!!r)};b.contains=b.include=function(t,n){return null==t?!1:v&&t.indexOf===v?-1!=t.indexOf(n):E(t,function(t){return t===n})},b.invoke=function(t,n){var e=s.call(arguments,2);return b.map(t,function(t){return(b.isFunction(n)?n:t[n]).apply(t,e)})},b.pluck=function(t,n){return b.map(t,function(t){return t[n]})},b.where=function(t,n){return b.isEmpty(n)?[]:b.filter(t,function(t){for(var e in n)if(n[e]!==t[e])return!1;return!0})},b.max=function(t,n,e){if(!n&&b.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.max.apply(Math,t);if(!n&&b.isEmpty(t))return-1/0;var i={computed:-1/0,value:-1/0};return S(t,function(t,r,o){var u=n?n.call(e,t,r,o):t;u>=i.computed&&(i={value:t,computed:u})}),i.value},b.min=function(t,n,e){if(!n&&b.isArray(t)&&t[0]===+t[0]&&65535>t.length)return Math.min.apply(Math,t);if(!n&&b.isEmpty(t))return 1/0;var i={computed:1/0,value:1/0};return S(t,function(t,r,o){var u=n?n.call(e,t,r,o):t;i.computed>u&&(i={value:t,computed:u})}),i.value},b.shuffle=function(t){var n,e=0,i=[];return S(t,function(t){n=b.random(e++),i[e-1]=i[n],i[n]=t}),i};var A=function(t){return b.isFunction(t)?t:function(n){return n[t]}};b.sortBy=function(t,n,e){var i=A(n);return b.pluck(b.map(t,function(t,n,r){return{value:t,index:n,criteria:i.call(e,t,n,r)}}).sort(function(t,n){var e=t.criteria,i=n.criteria;if(e!==i){if(e>i||void 0===e)return 1;if(i>e||void 0===i)return-1}return t.index<n.index?-1:1}),"value")};var j=function(t,n,e,i){var r={},o=A(n||b.identity);return S(t,function(n,u){var s=o.call(e,n,u,t);i(r,s,n)}),r};b.groupBy=function(t,n,e){return j(t,n,e,function(t,n,e){(b.has(t,n)?t[n]:t[n]=[]).push(e)})},b.countBy=function(t,n,e){return j(t,n,e,function(t,n){b.has(t,n)||(t[n]=0),t[n]++})},b.sortedIndex=function(t,n,e,i){e=null==e?b.identity:A(e);for(var r=e.call(i,n),o=0,u=t.length;u>o;){var s=o+u>>>1;r>e.call(i,t[s])?o=s+1:u=s}return o},b.toArray=function(t){return t?b.isArray(t)?s.call(t):t.length===+t.length?b.map(t,b.identity):b.values(t):[]},b.size=function(t){return null==t?0:t.length===+t.length?t.length:b.keys(t).length},b.first=b.head=b.take=function(t,n,e){return null==t?void 0:null==n||e?t[0]:s.call(t,0,n)},b.initial=function(t,n,e){return s.call(t,0,t.length-(null==n||e?1:n))},b.last=function(t,n,e){return null==t?void 0:null==n||e?t[t.length-1]:s.call(t,Math.max(t.length-n,0))},b.rest=b.tail=b.drop=function(t,n,e){return s.call(t,null==n||e?1:n)},b.compact=function(t){return b.filter(t,b.identity)};var T=function(t,n,e){return S(t,function(t){b.isArray(t)?n?u.apply(e,t):T(t,n,e):e.push(t)}),e};b.flatten=function(t,n){return T(t,n,[])},b.without=function(t){return b.difference(t,s.call(arguments,1))},b.uniq=b.unique=function(t,n,e,i){b.isFunction(n)&&(i=e,e=n,n=!1);var r=e?b.map(t,e,i):t,o=[],u=[];return S(r,function(e,i){(n?i&&u[u.length-1]===e:b.contains(u,e))||(u.push(e),o.push(t[i]))}),o},b.union=function(){return b.uniq(a.apply(i,arguments))},b.intersection=function(t){var n=s.call(arguments,1);return b.filter(b.uniq(t),function(t){return b.every(n,function(n){return b.indexOf(n,t)>=0})})},b.difference=function(t){var n=a.apply(i,s.call(arguments,1));return b.filter(t,function(t){return!b.contains(n,t)})},b.zip=function(){for(var t=s.call(arguments),n=b.max(b.pluck(t,"length")),e=Array(n),i=0;n>i;i++)e[i]=b.pluck(t,""+i);return e},b.object=function(t,n){if(null==t)return{};for(var e={},i=0,r=t.length;r>i;i++)n?e[t[i]]=n[i]:e[t[i][0]]=t[i][1];return e},b.indexOf=function(t,n,e){if(null==t)return-1;var i=0,r=t.length;if(e){if("number"!=typeof e)return i=b.sortedIndex(t,n),t[i]===n?i:-1;i=0>e?Math.max(0,r+e):e}if(v&&t.indexOf===v)return t.indexOf(n,e);for(;r>i;i++)if(t[i]===n)return i;return-1},b.lastIndexOf=function(t,n,e){if(null==t)return-1;var i=null!=e;if(x&&t.lastIndexOf===x)return i?t.lastIndexOf(n,e):t.lastIndexOf(n);for(var r=i?e:t.length;r--;)if(t[r]===n)return r;return-1},b.range=function(t,n,e){1>=arguments.length&&(n=t||0,t=0),e=arguments[2]||1;for(var i=Math.max(Math.ceil((n-t)/e),0),r=0,o=Array(i);i>r;)o[r++]=t,t+=e;return o};var k=function(){};b.bind=function(t,n){var e,i;if(t.bind===_&&_)return _.apply(t,s.call(arguments,1));if(!b.isFunction(t))throw new TypeError;return e=s.call(arguments,2),i=function(){if(!(this instanceof i))return t.apply(n,e.concat(s.call(arguments)));k.prototype=t.prototype;var r=new k;k.prototype=null;var o=t.apply(r,e.concat(s.call(arguments)));return Object(o)===o?o:r}},b.bindAll=function(t){var n=s.call(arguments,1);return 0==n.length&&(n=b.functions(t)),S(n,function(n){t[n]=b.bind(t[n],t)}),t},b.memoize=function(t,n){var e={};return n||(n=b.identity),function(){var i=n.apply(this,arguments);return b.has(e,i)?e[i]:e[i]=t.apply(this,arguments)}},b.delay=function(t,n){var e=s.call(arguments,2);return setTimeout(function(){return t.apply(null,e)},n)},b.defer=function(t){return b.delay.apply(b,[t,1].concat(s.call(arguments,1)))},b.throttle=function(t,n){var e,i,r,o,u=0,s=function(){u=new Date,r=null,o=t.apply(e,i)};return function(){var a=new Date,l=n-(a-u);return e=this,i=arguments,0>=l?(clearTimeout(r),r=null,u=a,o=t.apply(e,i)):r||(r=setTimeout(s,l)),o}},b.debounce=function(t,n,e){var i,r;return function(){var o=this,u=arguments,s=function(){i=null,e||(r=t.apply(o,u))},a=e&&!i;return clearTimeout(i),i=setTimeout(s,n),a&&(r=t.apply(o,u)),r}},b.once=function(t){var n,e=!1;return function(){return e?n:(e=!0,n=t.apply(this,arguments),t=null,n)}},b.wrap=function(t,n){return function(){var e=[t];return u.apply(e,arguments),n.apply(this,e)}},b.compose=function(){var t=arguments;return function(){for(var n=arguments,e=t.length-1;e>=0;e--)n=[t[e].apply(this,n)];return n[0]}},b.after=function(t,n){return 0>=t?n():function(){return 1>--t?n.apply(this,arguments):void 0}},b.keys=K||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var n=[];for(var e in t)b.has(t,e)&&(n[n.length]=e);return n},b.values=function(t){var n=[];for(var e in t)b.has(t,e)&&n.push(t[e]);return n},b.pairs=function(t){var n=[];for(var e in t)b.has(t,e)&&n.push([e,t[e]]);return n},b.invert=function(t){var n={};for(var e in t)b.has(t,e)&&(n[t[e]]=e);return n},b.functions=b.methods=function(t){var n=[];for(var e in t)b.isFunction(t[e])&&n.push(e);return n.sort()},b.extend=function(t){return S(s.call(arguments,1),function(n){if(n)for(var e in n)t[e]=n[e]}),t},b.pick=function(t){var n={},e=a.apply(i,s.call(arguments,1));return S(e,function(e){e in t&&(n[e]=t[e])}),n},b.omit=function(t){var n={},e=a.apply(i,s.call(arguments,1));for(var r in t)b.contains(e,r)||(n[r]=t[r]);return n},b.defaults=function(t){return S(s.call(arguments,1),function(n){if(n)for(var e in n)null==t[e]&&(t[e]=n[e])}),t},b.clone=function(t){return b.isObject(t)?b.isArray(t)?t.slice():b.extend({},t):t},b.tap=function(t,n){return n(t),t};var O=function(t,n,e,i){if(t===n)return 0!==t||1/t==1/n;if(null==t||null==n)return t===n;t instanceof b&&(t=t._wrapped),n instanceof b&&(n=n._wrapped);var r=l.call(t);if(r!=l.call(n))return!1;switch(r){case"[object String]":return t==n+"";case"[object Number]":return t!=+t?n!=+n:0==t?1/t==1/n:t==+n;case"[object Date]":case"[object Boolean]":return+t==+n;case"[object RegExp]":return t.source==n.source&&t.global==n.global&&t.multiline==n.multiline&&t.ignoreCase==n.ignoreCase}if("object"!=typeof t||"object"!=typeof n)return!1;for(var o=e.length;o--;)if(e[o]==t)return i[o]==n;e.push(t),i.push(n);var u=0,s=!0;if("[object Array]"==r){if(u=t.length,s=u==n.length)for(;u--&&(s=O(t[u],n[u],e,i)););}else{var a=t.constructor,c=n.constructor;if(a!==c&&!(b.isFunction(a)&&a instanceof a&&b.isFunction(c)&&c instanceof c))return!1;for(var h in t)if(b.has(t,h)&&(u++,!(s=b.has(n,h)&&O(t[h],n[h],e,i))))break;if(s){for(h in n)if(b.has(n,h)&&!u--)break;s=!u}}return e.pop(),i.pop(),s};b.isEqual=function(t,n){return O(t,n,[],[])},b.isEmpty=function(t){if(null==t)return!0;if(b.isArray(t)||b.isString(t))return 0===t.length;for(var n in t)if(b.has(t,n))return!1;return!0},b.isElement=function(t){return!(!t||1!==t.nodeType)},b.isArray=w||function(t){return"[object Array]"==l.call(t)},b.isObject=function(t){return t===Object(t)},S(["Arguments","Function","String","Number","Date","RegExp"],function(t){b["is"+t]=function(n){return l.call(n)=="[object "+t+"]"}}),b.isArguments(arguments)||(b.isArguments=function(t){return!(!t||!b.has(t,"callee"))}),b.isFunction=function(t){return"function"==typeof t},b.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},b.isNaN=function(t){return b.isNumber(t)&&t!=+t},b.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},b.isNull=function(t){return null===t},b.isUndefined=function(t){return void 0===t},b.has=function(t,n){return c.call(t,n)},b.noConflict=function(){return t._=n,this},b.identity=function(t){return t},b.times=function(t,n,e){for(var i=Array(t),r=0;t>r;r++)i[r]=n.call(e,r);return i},b.random=function(t,n){return null==n&&(n=t,t=0),t+(0|Math.random()*(n-t+1))};var R={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};R.unescape=b.invert(R.escape);var M={escape:RegExp("["+b.keys(R.escape).join("")+"]","g"),unescape:RegExp("("+b.keys(R.unescape).join("|")+")","g")};b.each(["escape","unescape"],function(t){b[t]=function(n){return null==n?"":(""+n).replace(M[t],function(n){return R[t][n]})}}),b.result=function(t,n){if(null==t)return null;var e=t[n];return b.isFunction(e)?e.call(t):e},b.mixin=function(t){S(b.functions(t),function(n){var e=b[n]=t[n];b.prototype[n]=function(){var t=[this._wrapped];return u.apply(t,arguments),N.call(this,e.apply(b,t))}})};var F=0;b.uniqueId=function(t){var n=""+ ++F;return t?t+n:n},b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var P=/(.)^/,I={"'":"'","\\":"\\","\r":"r","\n":"n"," ":"t","\u2028":"u2028","\u2029":"u2029"},q=/\\|'|\r|\n|\t|\u2028|\u2029/g;b.template=function(t,n,e){e=b.defaults({},e,b.templateSettings);var i=RegExp([(e.escape||P).source,(e.interpolate||P).source,(e.evaluate||P).source].join("|")+"|$","g"),r=0,o="__p+='";t.replace(i,function(n,e,i,u,s){return o+=t.slice(r,s).replace(q,function(t){return"\\"+I[t]}),e&&(o+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'"),i&&(o+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),u&&(o+="';\n"+u+"\n__p+='"),r=s+n.length,n}),o+="';\n",e.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{var u=Function(e.variable||"obj","_",o)}catch(s){throw s.source=o,s}if(n)return u(n,b);var a=function(t){return u.call(this,t,b)};return a.source="function("+(e.variable||"obj")+"){\n"+o+"}",a},b.chain=function(t){return b(t).chain()};var N=function(t){return this._chain?b(t).chain():t};b.mixin(b),S(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var n=i[t];b.prototype[t]=function(){var e=this._wrapped;return n.apply(e,arguments),"shift"!=t&&"splice"!=t||0!==e.length||delete e[0],N.call(this,e)}}),S(["concat","join","slice"],function(t){var n=i[t];b.prototype[t]=function(){return N.call(this,n.apply(this._wrapped,arguments))}}),b.extend(b.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(){window.Kona={},Kona.debugMode=!0,Kona.debug=function(t){return Kona.debugMode?console.log(t):void 0},window.puts=function(t){return Kona.debug(t)},Kona.readyCallbacks=[],Kona.isReady=!1,Kona.ready=function(t){return"complete"===document.readyState&&(Kona.isReady=!0),Kona.isReady&&t.call(),Kona.readyCallbacks.push(t)},Kona.DOMContentLoaded=function(){var t,n,e,i,r;if(!Kona.isReady){for(Kona.isReady=!0,i=Kona.readyCallbacks,r=[],n=0,e=i.length;e>n;n++)t=i[n],r.push(t.call());return r}},"complete"!==document.readyState&&(document.addEventListener?(document.addEventListener("DOMContentLoaded",Kona.DOMContentLoaded,!1),window.addEventListener("load",Kona.DOMContentLoaded,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",Kona.DOMContentLoaded),window.attachEvent("onload",Kona.DOMContentLoaded)))}.call(this),function(){Kona.Utils={find:function(t,n){return _.where(t,n)[0]},merge:function(t,n){var e;null==n&&(n={});for(e in n)t[e]=n[e];return t}},window.__k_once=0,window.once=function(t){return 0===__k_once&&t(),__k_once++},window.fail=function(t){throw Error(t)}}.call(this),function(){Kona.Canvas={defaults:{width:660,height:480},init:function(t){return this.elem=document.getElementById(t)||fail("Can't find element with id: "+t),this.ctx=this.elem.getContext("2d"),this.width=this.elem.width||this.defaults.width,this.height=this.elem.height||this.defaults.height},safe:function(t){return this.ctx.save(),t(),this.ctx.restore()},clear:function(){var t=this;return this.safe(function(){return t.ctx.fillStyle="white",t.ctx.fillRect(0,0,t.width,t.height)})},drawRect:function(t,n,e){var i=this;return null==e&&(e={}),this.safe(function(){return i.ctx.fillStyle=e.color||"black",i.ctx.fillRect(t.x,t.y,n.width,n.height)})},drawCircle:function(t,n){var e,i=this;return null==n&&(n={}),e=n.radius||fail("Must specify a radius"),this.safe(function(){return i.ctx.fillStyle=n.color||"black",i.ctx.beginPath(),i.ctx.arc(t.x,t.y,e,0,2*Math.PI,!1),i.ctx.closePath(),i.ctx.fill()})}}}.call(this),function(){Kona.Engine={defaults:{fps:24,width:660,height:480},running:!1,_queue:[],queue:function(t){return this.running?t():this._queue.push(t)},start:function(t){var n,e,i,r;for(null==t&&(t={}),this.fps=t.fps||this.defaults.fps,Kona.Scenes.currentScene=Kona.Scenes.scenes[0],this.running=!0,r=this._queue,e=0,i=r.length;i>e;e++)n=r[e],n();return this.run()},run:function(){return requestAnimFrame(Kona.Engine.run,Kona.Canvas.elem),Kona.Scenes.drawCurrent()}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/Kona.Engine.defaults.fps)}}()}.call(this),function(){Kona.Scenes={maps:[],scenes:[],currentScene:{addEntity:function(t){return Kona.Engine.queue(function(){return Kona.Scenes.currentScene.addEntity(t)})}},loadDefinitions:function(t){var n,e,i,r,o,u;for(u=[],r=0,o=t.length;o>r;r++)n=t[r],u.push(function(){var t;t=[];for(i in n)e=n[i],t.push(this.maps.push({name:i,map:e}));return t}.call(this));return u},loadScenes:function(t){var n,e,i,r,o;for(null==t&&(t=[]),i=1,r=0,o=t.length;o>r;r++)n=t[r],e=new Kona.Scene(Kona.Utils.merge({name:"s"+i},n)),i++;return this.currentScene=this.scenes[0]},drawCurrent:function(){return this.currentScene.draw()},setCurrent:function(t){var n;return this.currentScene.active=!1,n=Kona.Utils.find(this.scenes,{name:t})||fail("Couldn't find scene: "+t),this.currentScene=n,this.currentScene.active=!0},nextScene:function(){var t;return t=parseInt(this.currentScene.name.replace("s","")),this.setCurrent("s"+ ++t)}},Kona.Scene=function(){function t(t){null==t&&(t={}),this.map=t.map||fail("Scene must have a map"),this.name=t.name||fail("Scene must have a name"),this.active=null!=t.active?t.active:!1,this.background=new Image,this.background.src=t.background||"",this.entities={},null!=t.entities&&this.loadEntities(t.entities),Kona.Scenes.scenes.push(this)}return t.prototype.addEntity=function(t){var n,e;return n=t.group,(e=this.entities)[n]||(e[n]=[]),this.entities[n].push(t)},t.prototype.loadEntities=function(t){var n,e,i,r,o,u,s,a,l,c,h,p,f,d,y,m;for(c=0,h=Kona.Canvas.height-t.length*Kona.Tile.tileSize,e=Kona.Utils.find(Kona.Scenes.maps,{name:this.map}).map,m=[],p=0,d=t.length;d>p;p++){for(u=t[p],f=0,y=u.length;y>f;f++)n=u[f],s=e[n]||fail("No mapping found for rule: "+n),r=s.opts?s.opts.offset:null,a=null!=r?c+(r.x||0):c,l=null!=r?h+(r.y||0):h,o=Kona.Utils.merge({x:a,y:l,group:s.group},s.opts),i=new s.entity(o),this.addEntity(i),c+=Kona.Tile.tileSize;c=0,m.push(h+=Kona.Tile.tileSize)}return m},t.prototype.removeEntity=function(t){var n,e,i,r,o,u;for(i=this.entities[t.group],u=[],e=r=0,o=i.length;o>r;e=++r)n=i[e],t===n?u.push(i.splice(e,1)):u.push(void 0);return u},t.prototype.draw=function(){var t,n,e,i,r;Kona.Canvas.clear(),Kona.Canvas.ctx.drawImage(this.background,0,0),i=this.entities,r=[];for(e in i)n=i[e],r.push(function(){var e,i,r;for(r=[],e=0,i=n.length;i>e;e++)t=n[e],null!=t?(t.update(),r.push(t.draw())):r.push(void 0);return r}());return r},t}()}.call(this),function(){var t=function(t,n){return function(){return t.apply(n,arguments)}},n=[].slice;Kona.Entity=function(){function e(n){var e;null==n&&(n={}),this.onSurface=t(this.onSurface,this),this.eachSolidEntity=t(this.eachSolidEntity,this),this.group=n.group||fail("entity must have a group"),this.solid=n.solid||!0,this.gravity=n.gravity||!0,this.speed=n.speed||0,this.facing=n.facing||"",this.sprite=new Image,this.sprite.src=n.sprite||null,this.position={x:n.x||0,y:n.y||0},this.direction={dx:n.dx||0,dy:n.dy||0},this.box={width:n.width||0,height:n.height||0},e=this,this.sprite.onload=function(){return 0===e.box.width&&(e.box.width=this.width),0===e.box.height?e.box.height=this.height:void 0},this.animations=[],this.currentAnimation=null}return e.grav=8,e.loadAnimations=function(t,n){var e=this;return Kona.Engine.queue(function(){var i,r,o,u,s;if(r=Kona.Scenes.currentScene.entities[t],null!=r){for(s=[],o=0,u=r.length;u>o;o++)i=r[o],i instanceof e?s.push(i.loadAnimations(n)):s.push(void 0);return s}})},e.prototype.update=function(){return this.direction.dx>0?this.facing="right":0>this.direction.dx&&(this.facing="left"),this.position.x+=this.speed*this.direction.dx,this.position.y+=this.speed*this.direction.dy,this.correctLeft(),this.correctRight()},e.prototype.draw=function(){return null!=this.currentAnimation?this.currentAnimation.draw():Kona.Canvas.ctx.drawImage(this.sprite,this.position.x,this.position.y,this.box.width,this.box.height)},e.prototype.destroy=function(){return Kona.Scenes.currentScene.removeEntity(this)},e.prototype.top=function(){return this.position.y},e.prototype.bottom=function(){return this.position.y+this.box.height},e.prototype.left=function(){return this.position.x},e.prototype.right=function(){return this.position.x+this.box.width},e.prototype.midx=function(){return this.position.x+Math.ceil(this.box.width/2)},e.prototype.midy=function(){return this.position.y+Math.ceil(this.box.height/2)},e.prototype.movingLeft=function(){return 0>this.direction.dx},e.prototype.movingRight=function(){return this.direction.dx>0},e.prototype.addGravity=function(){return this.gravity?(this.position.y+=Kona.Entity.grav,this.correctBottom()):void 0},e.prototype.setPosition=function(t,n){return this.position.x=t,this.position.y=n},e.prototype.stop=function(t){return null==t&&(t=null),null!=t?this.direction["d"+t]=0:this.direction.dx=this.direction.dy=0},e.prototype.inRowSpace=function(t){return this.bottom()>t.top()&&this.top()<t.bottom()},e.prototype.inColumnSpace=function(t){return this.left()<t.right()&&this.right()>t.left()},e.prototype.neighborEntities=function(t){var n,e,i,r,o,u,s;null==t&&(t={}),r={},s=Kona.Scenes.currentScene.entities;for(i in s)for(e=s[i],o=0,u=e.length;u>o;o++)n=e[o],r[i]||(r[i]=[]),n!==this&&r[i].push(n);return r},e.prototype.eachSolidEntity=function(t){var n,e,i,r,o;r=this.neighborEntities(),o=[];for(i in r)e=r[i],o.push(function(){var i,r,o;for(o=[],i=0,r=e.length;r>i;i++)n=e[i],null!=n&&n.solid?o.push(t(n)):o.push(void 0);return o}());return o},e.prototype.anyCollisions=function(t){var n;return n=!1,this.eachSolidEntity(function(e){return t(e)?n=!0:void 0}),n},e.prototype.leftCollision=function(t){return this.right()>=t.right()+1&&this.left()<=t.right()+1&&this.inRowSpace(t)},e.prototype.hasLeftCollisions=function(){var t=this;return this.anyCollisions(function(n){return t.leftCollision(n)})},e.prototype.rightCollision=function(t){return this.left()<=t.left()+1&&this.right()>=t.left()+1&&this.inRowSpace(t)},e.prototype.hasRightCollisions=function(){var t=this;return this.anyCollisions(function(n){return t.rightCollision(n)})},e.prototype.topCollision=function(t){return this.bottom()>=t.bottom()+1&&this.top()<=t.bottom()+1&&this.inColumnSpace(t)},e.prototype.hasTopCollisions=function(){var t=this;return this.anyCollisions(function(n){return t.topCollision(n)})},e.prototype.bottomCollision=function(t){return this.top()<=t.top()&&this.bottom()>=t.top()&&this.inColumnSpace(t)},e.prototype.hasBottomCollisions=function(){var t=this;return this.anyCollisions(function(n){return t.bottomCollision(n)})},e.prototype.intersecting=function(t){return this.leftCollision(t)||this.rightCollision(t)||this.topCollision(t)||this.bottomCollision(t)},e.prototype.onSurface=function(){var t,n,e,i,r,o;o=this.neighborEntities();for(e in o)for(n=o[e],i=0,r=n.length;r>i;i++)if(t=n[i],t.solid&&t.position.y===this.bottom()+1)return!0;return!1},e.prototype.correctLeft=function(){var t;for(t=[];this.hasLeftCollisions()||0>this.left();)t.push(this.position.x+=1);return t},e.prototype.correctRight=function(){var t;for(t=[];this.hasRightCollisions();)t.push(this.position.x-=1);return t},e.prototype.correctTop=function(){var t;for(t=[];this.hasTopCollisions();)t.push(this.position.y+=1);return t},e.prototype.correctBottom=function(){var t;for(t=[];this.hasBottomCollisions();)t.push(this.position.y-=1);return t},e.prototype.collects=function(){var t,e,i,r,o;for(e=arguments.length>=1?n.call(arguments,0):[],o=[],i=0,r=e.length;r>i;i++)t=e[i],o.push(Kona.Collectors.add(t,this));return o},e.prototype.loadAnimations=function(t){var n,e,i,r;r=[];for(e in t)i=t[e],n=Kona.Utils.merge({entity:this,name:e,width:this.box.width,height:this.box.height},i),this.animations[e]=new Kona.Animation(n),n.active===!0?r.push(this.setAnimation(e)):r.push(void 0);return r},e.prototype.setAnimation=function(t){return this.currentAnimation=this.animations[t]||fail("Couldn't find animation with name "+t)},e.prototype.clearAnimation=function(){return this.currentAnimation=null},e.prototype.include=function(){var t,e,i,r,o;for(e=arguments.length>=1?n.call(arguments,0):[],o=[],i=0,r=e.length;r>i;i++)t=e[i],o.push(Kona.Utils.merge(this,t));return o},e}()}.call(this),function(){Kona.Animation=function(){function t(t){null==t&&(t={}),this.lastUpdateTime=0,this.elapsed=0,this.msPerFrame=t.msPerFrame||25,this.entity=t.entity,this.name=t.name,this.image=new Image,this.image.src=t.sheet,this.position={x:0,y:0},this.frames={width:t.width,height:t.height},this.repeat=null!=t.repeat?t.repeat:!0,this.next=t.next||null,this.played=!1}return t.prototype.triggerNext=function(){return _.isString(this.next)?this.entity.setAnimation(this.next):_.isFunction(this.next)?this.next():void 0},t.prototype.update=function(){var t;return t=Date.now()-this.lastUpdateTime,this.elapsed>this.msPerFrame?(this.elapsed=0,this.position.x+=this.frames.width,this.position.x+this.frames.width>this.image.width&&(this.position.x=0,this.position.y+=this.frames.height,this.position.y+this.frames.height>=this.image.height&&this.reset())):this.elapsed+=t,this.lastUpdateTime=Date.now()},t.prototype.draw=function(){var t,n,e,i;return e=this.entity.position.x,i=this.entity.position.y,n=this.entity.box.width,t=this.entity.box.height,this.repeat||!this.played?(Kona.Canvas.ctx.drawImage(this.image,this.position.x,this.position.y,this.frames.width,this.frames.height,e,i,n,t),this.update()):void 0},t.prototype.reset=function(){return this.played=!0,this.triggerNext(),this.position.x=this.position.y=0},t}()}.call(this),function(){var t={}.hasOwnProperty,n=function(n,e){function i(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return i.prototype=e.prototype,n.prototype=new i,n.__super__=e.prototype,n};Kona.Tile=function(t){function e(t){null==t&&(t={}),e.__super__.constructor.call(this,t),this.size=Kona.Tile.tileSize,this.box={width:this.size,height:this.size}}return n(e,t),e.tileSize=60,e.prototype.update=function(){},e}(Kona.Entity),Kona.BlankTile=function(t){function e(t){e.__super__.constructor.call(this,t),this.solid=!1}return n(e,t),e.prototype.update=function(){},e.prototype.draw=function(){},e}(Kona.Tile)}.call(this),function(){var t={}.hasOwnProperty,n=function(n,e){function i(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return i.prototype=e.prototype,n.prototype=new i,n.__super__=e.prototype,n};Kona.Collectable=function(t){function e(t){null==t&&(t={}),e.__super__.constructor.call(this,t),this.solid=!1,this.gravity=!1}return n(e,t),e.prototype.update=function(){var t,n,e,i,r;if(t=Kona.Collectors["for"](this.group),null!=t){for(r=[],e=0,i=t.length;i>e;e++)n=t[e],this.intersecting(n)?(this.activate(n),r.push(this.destroy())):r.push(void 0);return r}},e.prototype.activate=function(){return fail("Implement activate() in a derived Collectable class")},e}(Kona.Entity),Kona.Collectors={_store:{},add:function(t,n){var e;return(e=this._store)[t]||(e[t]=[]),this._store[t].push(n)},"for":function(t){return this._store[t]}}}.call(this),function(){Kona.Keys={_handlers:{},_keycodes:{enter:13,"return":13,esc:27,escape:27,ctrl:17,control:17,left:37,up:38,right:39,down:40,shift:16,space:32},_names:{13:"enter",16:"shift",17:"ctrl",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},bind:function(t,n){var e,i;return t=t.replace(/\s/g,""),e=this._keycodes[t]||t.toUpperCase().charCodeAt(0),(i=this._handlers)[e]||(i[e]=[]),this._handlers[e].push(n)},dispatch:function(t){var n,e,i,r,o,u;if(e=this.eventKeyCode(t),!this.reject(t)&&null!=this._handlers[e]){for(o=this._handlers[e],u=[],i=0,r=o.length;r>i;i++)n=o[i],n.call(t),u.push(!1);return u}},reject:function(t){return _.contains(["INPUT","SELECT","TEXTAREA"],t.target.tagName)},keycodeName:function(t){return this._names[this.eventKeyCode(t)]},eventKeyCode:function(t){return t.which||t.keyCode}},Kona.ready(function(){return document.body.onkeydown=function(t){var n;return n=Kona.Keys.keycodeName(t),Kona.Keys.keydown?Kona.Keys.keydown(n):void 0},document.body.onkeyup=function(t){var n;return n=Kona.Keys.keycodeName(t),Kona.Keys.keyup?Kona.Keys.keyup(n):void 0},document.addEventListener("keydown",Kona.Keys.dispatch.bind(Kona.Keys),!1)})}.call(this),function(){Kona.Sounds={sounds:{},load:function(t){var n,e,i;null==t&&(t={}),i=[];for(n in t)e=t[n],i.push(this.sounds[n]=new Kona.Sound(e));return i},play:function(t){return this.sounds[t].play()}},Kona.Sound=function(){function t(t,n){var e,i,r,o,u,s,a,l,c,h=this;if(null==n&&(n={}),this.supported=Kona.Sound.isSupported(),this.supported&&null!=t){l=Kona.Sound.defaults;for(e in l)r=l[e],n[e]=n[e]||r}if(this.el=document.createElement("audio"),_.isArray(t))for(o=0,s=t.length;s>o;o++)i=t[o],this.addSource(this.el,i);else if(null!=n.formats&&n.formats.length)for(c=n.formats,r=u=0,a=c.length;a>u;r=++u)e=c[r],this.addSource(this.el,""+t+"."+e);else this.addSource(this.el,t);n.autoplay===!0&&(this.el.autoplay="autoplay"),this.el.preload=n.preload===!0?"auto":"none",this.setVolume(n.volume),this.el.addEventListener("loadedmetadata",function(){return h.duration=h.el.duration})}return t.defaults={autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:100},t.types={mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},t.testEl=document.createElement("audio"),t.isSupported=function(){return!!this.testEl.canPlayType},t.isOGGSupported=function(){return this.testEl.canPlayType('audio/ogg codecs="vorbis"')},t.isWAVSupported=function(){return this.testEl.canPlayType('audio/wav codecs="1"')},t.isMP3Supported=function(){return this.testEl.canPlayType('audio/mpeg codecs="mp3"')},t.isAACSupported=function(){return this.testEl.canPlayType("audio/x-m4a")||this.testEl.canPlayType("audio/aac")},t.supportedFormats=function(){var t;return t=function(t){return""===t?"yes":t},Kona.debug("Audio format compatability:"),Kona.debug("  OGG: "+t(this.isOGGSupported())),Kona.debug("  WAV: "+t(this.isWAVSupported())),Kona.debug("  MP3: "+t(this.isMP3Supported())),Kona.debug("  AAC: "+t(this.isAACSupported()))},t.prototype.getExt=function(t){return t.split(".").pop()},t.prototype.addSource=function(t,n){var e,i;return i=document.createElement("source"),i.src=n,e=this.getExt(n),null!=Kona.Sound.types[e]&&(i.type=Kona.Sound.types[e]),t.appendChild(i)},t.prototype.load=function(){return this.supported?this.el.load():this},t.prototype.play=function(){return this.supported?this.el.play():this},t.prototype.togglePlay=function(){return this.supported?(this.el.paused?this.el.play():this.el.pause(),this):this},t.prototype.pause=function(){return this.supported?this.el.pause():this},t.prototype.isPaused=function(){return this.supported?this.el.paused:null},t.prototype.stop=function(){return this.supported?(this.el.currentTime=this.el.duration,this.el.pause()):null},t.prototype.isEnded=function(){return this.supported?this.el.ended:null},t.prototype.getDuration=function(){return this.supported?this.duration:null},t.prototype.mute=function(){return this.supported?this.el.muted=!0:null},t.prototype.unmute=function(){return this.supported?this.el.muted=!1:null},t.prototype.isMuted=function(){return this.supported?this.el.muted:null},t.prototype.toggleMute=function(){return this.supported?this.el.muted=!this.el.muted:null},t.prototype.setVolume=function(t){return this.supported?(0>t&&(t=0),t>100&&(t=100),this.volume=t,this.el.volume=t/100,this):this},t.prototype.getVolume=function(){return this.supported?this.volume:null},t.prototype.increaseVolume=function(t){return null==t&&(t=1),this.setVolume(this.volume+t)},t.prototype.decreaseVolume=function(t){return null==t&&(t=1),this.setVolume(this.volume-t)
},t.prototype.getTime=function(){var t;return this.supported?(t=Math.round(100*this.el.currentTime)/100,isNaN(t)?Kona.Sound.defaults.placeholder:t):null},t.prototype.getDuration=function(){return this.supported?this.el.duration:null},t}()}.call(this),function(){var t={}.hasOwnProperty,n=function(n,e){function i(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return i.prototype=e.prototype,n.prototype=new i,n.__super__=e.prototype,n};Kona.Menu=function(t){function e(t){var n=this;null==t&&(t={}),e.__super__.constructor.call(this,t),this.fontSize=t.fontSize||"30px",this.font=t.font||"Times New Roman",this.textAlign=t.textAlign||"center",this.textColor=t.textColor||"white",this.selectedColor=t.selectedColor||"yellow",this.options=t.options,this.trigger=t.trigger,null!=this.trigger&&Kona.Keys.bind(this.trigger,function(){return Kona.Canvas.clear(),Kona.Scenes.setCurrent(n.name)})}return n(e,t),e.prototype.draw=function(){var t=this;return Kona.Canvas.safe(function(){var n,e,i,r,o,u;Kona.Canvas.ctx.font=""+t.fontSize+" "+t.font,Kona.Canvas.ctx.textAlign=t.textAlign,i=(Kona.Canvas.height-parseInt(t.fontSize)*_.size(t.options))/2,r=0,o=t.options,u=[];for(e in o)n=o[e],Kona.Canvas.ctx.fillStyle="red",Kona.Canvas.ctx.fillText(e,Kona.Canvas.width/2,i+r),u.push(r+=parseInt(t.fontSize)+20);return u})},e}(Kona.Scene)}.call(this),function(){var t={}.hasOwnProperty,n=function(n,e){function i(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return i.prototype=e.prototype,n.prototype=new i,n.__super__=e.prototype,n};Kona.Weapon=function(t){function e(t){null==t&&(t={}),e.__super__.constructor.call(this,t),this.canFire=!0,this.recharge=t.recharge||300,this.projType=t.projType||null,this.projSound=t.sound||"",this.holder=t.holder||null}return n(e,t),e.prototype.activate=function(t){return this.holder=t,t.currentWeapon=this},e.prototype.fire=function(){var t,n,e,i,r=this;return this.canFire?(n="right"===this.holder.facing?1:-1,e="right"===this.holder.facing?this.holder.right()+1:this.holder.left()-30,i=this.holder.top()+9,t=new this.projType({group:"projectiles",x:e,y:i,dx:n}),Kona.Scenes.currentScene.addEntity(t),""!==this.projSound&&Kona.Sounds.play(this.projSound),this.canFire=!1,setTimeout(function(){return r.canFire=!0},this.recharge)):void 0},e}(Kona.Collectable),Kona.EnemyWeapon=function(t){function e(t){null==t&&(t={}),this.targets=t.targets,this.projOffset=t.offset||{x:0,y:0},e.__super__.constructor.call(this,t)}return n(e,t),e.prototype.randomTarget=function(){var t,n,e,i,r;for(n=[],r=this.targets,e=0,i=r.length;i>e;e++)t=r[e],n=n.concat(Kona.Scenes.currentScene.entities[t]);return _.shuffle(n)[0]},e.prototype.fire=function(){var t,n,e,i,r,o,u,s,a,l,c,h;return s=this.randomTarget(),s.isAlive&&(c=Math.abs(this.holder.midx()-s.midx()),h=Math.abs(this.holder.midy()-s.midy()),a=this.holder.position.x>=s.midx(),l=this.holder.position.y>=s.midy(),t=Math.atan2(h,c)+(l?.5:0),r=1,e=r*Math.cos(t)*(a?-1:1),i=r*Math.sin(t)*(l?-1:1),o=a?this.holder.left()-this.projOffset.x:this.holder.right()+this.projOffset.x,u=this.holder.top()+this.projOffset.y,n=new this.projType({group:"projectiles",x:o,y:u,dx:e,dy:i,target:s}),Kona.Scenes.currentScene.addEntity(n),""!==this.projSound)?Kona.Sounds.play(this.projSound):void 0},e}(Kona.Weapon)}.call(this),function(){var t={}.hasOwnProperty,n=function(n,e){function i(){this.constructor=n}for(var r in e)t.call(e,r)&&(n[r]=e[r]);return i.prototype=e.prototype,n.prototype=new i,n.__super__=e.prototype,n};Kona.Projectile=function(t){function e(t){null==t&&(t={}),e.__super__.constructor.call(this,t),this.target=t.target||null,this.speed=t.speed||10}return n(e,t),e.prototype.update=function(){var t,n,i,r,o,u;if(e.__super__.update.call(this),this.position.x+=this.speed*this.direction.dx,this.hasLeftCollisions()||this.hasRightCollisions()){u=this.neighborEntities();for(i in u)for(n=u[i],r=0,o=n.length;o>r;r++)t=n[r],t.solid&&(this.leftCollision(t)||this.rightCollision(t))&&((this.target===t||_.contains(this.destructibles,i))&&(null!=t.hit?t.hit():t.destroy()),this.destroy())}return 0>this.position.x||this.position.x>Kona.Canvas.width?this.destroy():void 0},e}(Kona.Entity)}.call(this);