(function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return e instanceof x?e:this instanceof x?(this._wrapped=e,void 0):new x(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.4.3";var T=x.each=x.forEach=function(e,t,r){if(null!=e)if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return null==e?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)};var N="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);if(T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)}),!i)throw new TypeError(N);return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;if(null==e&&(e=[]),d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=x.keys(e);s=o.length}if(T(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)}),!i)throw new TypeError(N);return n},x.find=x.detect=function(e,t,n){var r;return C(e,function(e,i,s){return t.call(n,e,i,s)?(r=e,!0):void 0}),r},x.filter=x.select=function(e,t,n){var r=[];return null==e?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){return x.filter(e,function(e,r,i){return!t.call(n,e,r,i)},n)},x.every=x.all=function(e,t,r){t||(t=x.identity);var i=!0;return null==e?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){return(i=i&&t.call(r,e,s,o))?void 0:n}),!!i)};var C=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return null==e?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){return i||(i=t.call(r,e,s,o))?n:void 0}),!!i)};x.contains=x.include=function(e,t){return null==e?!1:y&&e.indexOf===y?-1!=e.indexOf(t):C(e,function(e){return e===t})},x.invoke=function(e,t){var n=u.call(arguments,2);return x.map(e,function(e){return(x.isFunction(t)?t:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.where=function(e,t){return x.isEmpty(t)?[]:x.filter(e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-1/0;var r={computed:-1/0,value:-1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return 1/0;var r={computed:1/0,value:1/0};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;r.computed>o&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t,n=0,r=[];return T(e,function(e){t=x.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return x.isFunction(e)?e:function(t){return t[e]}};x.sortBy=function(e,t,n){var r=k(t);return x.pluck(x.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t||x.identity);return T(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};x.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(x.has(e,t)?e[t]:e[t]=[]).push(n)})},x.countBy=function(e,t,n){return L(e,t,n,function(e,t){x.has(e,t)||(e[t]=0),e[t]++})},x.sortedIndex=function(e,t,n,r){n=null==n?x.identity:k(n);for(var i=n.call(r,t),s=0,o=e.length;o>s;){var u=s+o>>>1;i>n.call(r,e[u])?s=u+1:o=u}return s},x.toArray=function(e){return e?x.isArray(e)?u.call(e):e.length===+e.length?x.map(e,x.identity):x.values(e):[]},x.size=function(e){return null==e?0:e.length===+e.length?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:u.call(e,0,t)},x.initial=function(e,t,n){return u.call(e,0,e.length-(null==t||n?1:t))},x.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},x.rest=x.tail=x.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},x.compact=function(e){return x.filter(e,x.identity)};var A=function(e,t,n){return T(e,function(e){x.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};x.flatten=function(e,t){return A(e,t,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n,r){x.isFunction(t)&&(r=n,n=t,t=!1);var i=n?x.map(e,n,r):e,s=[],o=[];return T(i,function(n,r){(t?r&&o[o.length-1]===n:x.contains(o,n))||(o.push(n),s.push(e[r]))}),s},x.union=function(){return x.uniq(a.apply(r,arguments))},x.intersection=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=a.apply(r,u.call(arguments,1));return x.filter(e,function(e){return!x.contains(t,e)})},x.zip=function(){for(var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=Array(t),r=0;t>r;r++)n[r]=x.pluck(e,""+r);return n},x.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},x.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;i>r;r++)if(e[r]===t)return r;return-1},x.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=null!=n;if(b&&e.lastIndexOf===b)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var i=r?n:e.length;i--;)if(e[i]===t)return i;return-1},x.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=Array(r);r>i;)s[i++]=e,e+=n;return s};var O=function(){};x.bind=function(e,t){var n,r;if(e.bind===S&&S)return S.apply(e,u.call(arguments,1));if(!x.isFunction(e))throw new TypeError;return n=u.call(arguments,2),r=function(){if(this instanceof r){O.prototype=e.prototype;var i=new O;O.prototype=null;var s=e.apply(i,n.concat(u.call(arguments)));return Object(s)===s?s:i}return e.apply(t,n.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return 0==t.length&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o=0,u=function(){o=new Date,i=null,s=e.apply(n,r)};return function(){var a=new Date,f=t-(a-o);return n=this,r=arguments,0>=f?(clearTimeout(i),i=null,o=a,s=e.apply(n,r)):i||(i=setTimeout(u,f)),s}},x.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},x.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},x.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push(e[n]);return t},x.pairs=function(e){var t=[];for(var n in e)x.has(e,n)&&t.push([n,e[n]]);return t},x.invert=function(e){var t={};for(var n in e)x.has(e,n)&&(t[e[n]]=n);return t},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return T(n,function(n){n in e&&(t[n]=e[n])}),t},x.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)x.contains(n,i)||(t[i]=e[i]);return t},x.defaults=function(e){return T(u.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e};var M=function(e,t,n,r){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof x&&(e=e._wrapped),t instanceof x&&(t=t._wrapped);var i=f.call(e);if(i!=f.call(t))return!1;switch(i){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var s=n.length;s--;)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if("[object Array]"==i){if(o=e.length,u=o==t.length)for(;o--&&(u=M(e[o],t[o],n,r)););}else{var a=e.constructor,l=t.constructor;if(a!==l&&!(x.isFunction(a)&&a instanceof a&&x.isFunction(l)&&l instanceof l))return!1;for(var c in e)if(x.has(e,c)&&(o++,!(u=x.has(t,c)&&M(e[c],t[c],n,r))))break;if(u){for(c in t)if(x.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};x.isEqual=function(e,t){return M(e,t,[],[])},x.isEmpty=function(e){if(null==e)return!0;if(x.isArray(e)||x.isString(e))return 0===e.length;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&1===e.nodeType},x.isArray=w||function(e){return"[object Array]"==f.call(e)},x.isObject=function(e){return e===Object(e)},T(["Arguments","Function","String","Number","Date","RegExp"],function(e){x["is"+e]=function(t){return f.call(t)=="[object "+e+"]"}}),x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),x.isFunction=function(e){return"function"==typeof e},x.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},x.isNaN=function(e){return x.isNumber(e)&&e!=+e},x.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==f.call(e)},x.isNull=function(e){return null===e},x.isUndefined=function(e){return void 0===e},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=Array(e),i=0;e>i;i++)r[i]=t.call(n,i);return r},x.random=function(e,t){return null==t&&(t=e,e=0),e+(0|Math.random()*(t-e+1))};var _={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};_.unescape=x.invert(_.escape);var D={escape:RegExp("["+x.keys(_.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(_.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(e){x[e]=function(t){return null==t?"":(""+t).replace(D[e],function(t){return _[e][t]})}}),x.result=function(e,t){if(null==e)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){var n=x[t]=e[t];x.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),F.call(this,n.apply(x,e))}})};var P=0;x.uniqueId=function(e){var t=""+ ++P;return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n"," ":"t","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(e,t,n){n=x.defaults({},n,x.templateSettings);var r=RegExp([(n.escape||H).source,(n.interpolate||H).source,(n.evaluate||H).source].join("|")+"|$","g"),i=0,s="__p+='";e.replace(r,function(t,n,r,o,u){return s+=e.slice(i,u).replace(j,function(e){return"\\"+B[e]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(s+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),o&&(s+="';\n"+o+"\n__p+='"),i=u+t.length,t}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var o=Function(n.variable||"obj","_",s)}catch(u){throw u.source=s,u}if(t)return o(t,x);var a=function(e){return o.call(this,e,x)};return a.source="function("+(n.variable||"obj")+"){\n"+s+"}",a},x.chain=function(e){return x(e).chain()};var F=function(e){return this._chain?x(e).chain():e};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];x.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],F.call(this,n)}}),T(["concat","join","slice"],function(e){var t=r[e];x.prototype[e]=function(){return F.call(this,t.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),window.Kona={},Kona.debugMode=!0,Kona.debug=function(e){if(Kona.debugMode)return console.log(e)},window.puts=function(e){return Kona.debug(e)},Kona.readyCallbacks=[],Kona.isReady=!1,Kona.ready=function(e){return document.readyState==="complete"&&(Kona.isReady=!0),Kona.isReady&&e.call(),Kona.readyCallbacks.push(e)},Kona.DOMContentLoaded=function(){var e,t,n,r,i;if(Kona.isReady)return;Kona.isReady=!0,r=Kona.readyCallbacks,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.call());return i},document.readyState!=="complete"&&(document.addEventListener?(document.addEventListener("DOMContentLoaded",Kona.DOMContentLoaded,!1),window.addEventListener("load",Kona.DOMContentLoaded,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",Kona.DOMContentLoaded),window.attachEvent("onload",Kona.DOMContentLoaded))),Kona.Utils={find:function(e,t){return _.where(e,t)[0]},merge:function(e,t){var n;for(n in t)e[n]=t[n];return e}},window.fail=function(e){throw new Error(e)},Kona.Canvas={defaults:{width:660,height:480},init:function(e){return this.elem=document.getElementById(e)||fail("Can't find element with id: "+e),this.ctx=this.elem.getContext("2d"),this.width=this.elem.width||this.defaults.width,this.height=this.elem.height||this.defaults.height},safe:function(e){return this.ctx.save(),e(),this.ctx.restore()},clear:function(){var e=this;return this.safe(function(){return e.ctx.fillStyle="white",e.ctx.fillRect(0,0,e.width,e.height)})}},Kona.Engine={defaults:{fps:24,width:640,height:480},start:function(e){return e==null&&(e={}),this.fps=e.fps||this.defaults.fps,Kona.Scenes.currentScene=Kona.Scenes.scenes[0],Kona.Scenes.loadQueue(),this.run()},run:function(){return requestAnimFrame(Kona.Engine.run,Kona.Canvas.elem),Kona.Scenes.drawCurrent()}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/Kona.Engine.defaults.fps)}}(),Kona.Scenes={scenes:[],definitionMap:null,_queue:[],currentScene:{addEntity:function(e){return Kona.Scenes._queue.push(e)}},loadQueue:function(){var e,t,n,r,i;r=this._queue,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.currentScene.addEntity(e));return i},loadScenes:function(e){var t,n,r,i;e==null&&(e=[]),n=1;for(r=0,i=e.length;r<i;r++)t=e[r],this.scenes.push(new Kona.Scene(Kona.Utils.merge({name:"s"+n},t))),n++;return this.currentScene=this.scenes[0]},drawCurrent:function(){return this.currentScene.draw()},setCurrent:function(e){var t;return this.currentScene.active=!1,t=Kona.Utils.find(this.scenes,{name:e})||fail("Couldn't find scene: "+e),this.currentScene=t,this.currentScene.active=!0},nextScene:function(){var e;return e=parseInt(this.currentScene.name.replace("s","")),this.setCurrent("s"+ ++e)}},Kona.Scene=function(){function e(e){e==null&&(e={}),this.active=e.active!=null?e.active:!1,this.name=e.name||fail("Scene must have a name"),this.background=new Image,this.background.src=e.background||"",this.entities={},this.loadEntities(e.entities)}return e.prototype.addEntity=function(e){var t,n;return t=e.group,(n=this.entities)[t]||(n[t]=[]),this.entities[t].push(e)},e.prototype.loadEntities=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;Kona.Scenes.definitionMap!=null||fail("No definition map found"),f=0,l=Kona.Canvas.height-e.length*Kona.Tile.tileSize,v=[];for(c=0,p=e.length;c<p;c++){s=e[c];for(h=0,d=s.length;h<d;h++)t=s[h],o=Kona.Scenes.definitionMap[t]||fail("No mapping found for rule: "+t),r=o.opts?o.opts.offset:null,u=r!=null?f+(r.x||0):f,a=r!=null?l+(r.y||0):l,i=Kona.Utils.merge({x:u,y:a,group:o.group},o.opts),n=new o.entity(i),this.addEntity(n),f+=Kona.Tile.tileSize;f=0,v.push(l+=Kona.Tile.tileSize)}return v},e.prototype.removeEntity=function(e){var t,n,r,i,s,o;r=this.entities[e.group],o=[];for(n=i=0,s=r.length;i<s;n=++i)t=r[n],e===t?o.push(r.splice(n,1)):o.push(void 0);return o},e.prototype.draw=function(){var e,t,n,r,i;Kona.Canvas.clear(),Kona.Canvas.ctx.drawImage(this.background,0,0),r=this.entities,i=[];for(n in r)t=r[n],i.push(function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++)e=t[n],e!=null?(e.update(),i.push(e.draw())):i.push(void 0);return i}());return i},e}();var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__slice=[].slice;Kona.Entity=function(){function e(e){var t;e==null&&(e={}),this.onSurface=__bind(this.onSurface,this),this.eachSolidEntity=__bind(this.eachSolidEntity,this),this.group=e.group||fail("entity must have a group"),this.solid=e.solid||!0,this.gravity=e.gravity||!0,this.speed=e.speed||0,this.facing=e.facing||"",this.sprite=new Image,this.sprite.src=e.sprite||null,this.position={x:e.x||0,y:e.y||0},this.direction={dx:e.dx||0,dy:e.dy||0},this.box={width:e.width||0,height:e.height||0},t=this,this.sprite.onload=function(){t.box.width===0&&(t.box.width=this.width);if(t.box.height===0)return t.box.height=this.height},this.animations=[],this.currentAnimation=null}return e.grav=8,e.prototype.update=function(){return this.direction.dx>0?this.facing="right":this.direction.dx<0&&(this.facing="left"),this.position.x+=this.speed*this.direction.dx,this.position.y+=this.speed*this.direction.dy,this.correctLeft(),this.correctRight()},e.prototype.draw=function(){return this.currentAnimation!=null?this.currentAnimation.draw():Kona.Canvas.ctx.drawImage(this.sprite,this.position.x,this.position.y,this.box.width,this.box.height)},e.prototype.destroy=function(){return Kona.Scenes.currentScene.removeEntity(this)},e.prototype.top=function(){return this.position.y},e.prototype.bottom=function(){return this.position.y+this.box.height},e.prototype.left=function(){return this.position.x},e.prototype.right=function(){return this.position.x+this.box.width},e.prototype.midx=function(){return this.position.x+Math.ceil(this.box.width/2)},e.prototype.midy=function(){return this.position.y+Math.ceil(this.box.height/2)},e.prototype.movingLeft=function(){return this.direction.dx<0},e.prototype.movingRight=function(){return this.direction.dx>0},e.prototype.addGravity=function(){if(this.gravity)return this.position.y+=Kona.Entity.grav,this.correctBottom()},e.prototype.setPosition=function(e,t){return this.position.x=e,this.position.y=t},e.prototype.stop=function(e){return e!=null?this.direction[e]=0:this.direction.dx=this.direction.dy=0},e.prototype.inRowSpace=function(e){return this.bottom()>e.top()&&this.top()<e.bottom()},e.prototype.inColumnSpace=function(e){return this.left()<e.right()&&this.right()>e.left()},e.prototype.neighborEntities=function(){var e,t,n,r,i,s,o;r={},o=Kona.Scenes.currentScene.entities;for(n in o){t=o[n];for(i=0,s=t.length;i<s;i++)e=t[i],r[n]||(r[n]=[]),e!==this&&r[n].push(e)}return r},e.prototype.eachSolidEntity=function(e){var t,n,r,i,s;i=this.neighborEntities(),s=[];for(r in i)n=i[r],s.push(function(){var r,i,s;s=[];for(r=0,i=n.length;r<i;r++)t=n[r],t!=null&&t.solid?s.push(e(t)):s.push(void 0);return s}());return s},e.prototype.isCollision=function(e){var t,n=this;return t=!1,this.eachSolidEntity(function(n){if(e(n))return t=!0}),t},e.prototype.leftCollision=function(e){return this.right()>=e.right()&&this.left()<=e.right()&&this.inRowSpace(e)},e.prototype.leftCollisions=function(){var e=this;return this.isCollision(function(t){return e.leftCollision(t)})},e.prototype.rightCollision=function(e){return this.left()<=e.left()&&this.right()>=e.left()&&this.inRowSpace(e)},e.prototype.rightCollisions=function(){var e=this;return this.isCollision(function(t){return e.rightCollision(t)})},e.prototype.topCollision=function(e){return this.bottom()>=e.bottom()&&this.top()<=e.bottom()&&this.inColumnSpace(e)},e.prototype.topCollisions=function(){var e=this;return this.isCollision(function(t){return e.topCollision(t)})},e.prototype.bottomCollision=function(e){return this.top()<=e.top()&&this.bottom()>=e.top()&&this.inColumnSpace(e)},e.prototype.bottomCollisions=function(){var e=this;return this.isCollision(function(t){return e.bottomCollision(t)})},e.prototype.intersecting=function(e){return this.leftCollision(e)||this.rightCollision(e)||this.topCollision(e)||this.bottomCollision(e)},e.prototype.onSurface=function(){var e,t,n,r,i,s;s=this.neighborEntities();for(n in s){t=s[n];for(r=0,i=t.length;r<i;r++){e=t[r];if(e.solid&&e.position.y===this.bottom()+1)return!0}}return!1},e.prototype.correctLeft=function(){var e;e=[];while(this.leftCollisions()||this.left()<0)e.push(this.position.x+=1);return e},e.prototype.correctRight=function(){var e;e=[];while(this.rightCollisions())e.push(this.position.x-=1);return e},e.prototype.correctTop=function(){var e;e=[];while(this.topCollisions())e.push(this.position.y+=1);return e},e.prototype.correctBottom=function(){var e;e=[];while(this.bottomCollisions())e.push(this.position.y-=1);return e},e.prototype.collects=function(){var e,t,n,r,i;t=1<=arguments.length?__slice.call(arguments,0):[],i=[];for(n=0,r=t.length;n<r;n++)e=t[n],i.push(Kona.Collectors.add(e,this));return i},e.prototype.active=function(){return _.contains(Kona.Scenes.currentScene.entities[this.group],this)},e.prototype.loadAnimations=function(e){var t,n,r,i;i=[];for(n in e)r=e[n],t=Kona.Utils.merge({entity:this,width:this.box.width,height:this.box.height},r),this.animations[n]=new Kona.Animation(t),t.active===!0?i.push(this.setAnimation(n)):i.push(void 0);return i},e.prototype.setAnimation=function(e){return this.currentAnimation=this.animations[e]||fail("Couldn't find animation with name "+e)},e.prototype.clearAnimation=function(){return this.currentAnimation=null},e}(),Kona.Animation=function(){function e(e){e==null&&(e={}),this.lastUpdateTime=0,this.elapsed=0,this.msPerFrame=e.msPerFrame||25,this.entity=e.entity,this.image=new Image,this.image.src=e.sheet,this.position={x:0,y:0},this.frames={width:e.width,height:e.height},this.repeat=e.repeat!=null?e.repeat:!0,this.next=e.next||null,this.played=!1}return e.prototype.triggerNext=function(){if(_.isString(this.next))return this.entity.setAnimation(this.next);if(_.isFunction(this.next))return this.next()},e.prototype.update=function(){var e;return e=Date.now()-this.lastUpdateTime,this.elapsed>this.msPerFrame?(this.elapsed=0,this.position.x+=this.frames.width,this.position.x+this.frames.width>this.image.width&&(this.position.x=0,this.position.y+=this.frames.height,this.position.y+this.frames.height>=this.image.height&&this.reset())):this.elapsed+=e,this.lastUpdateTime=Date.now()},e.prototype.draw=function(){var e,t,n,r;n=this.entity.position.x,r=this.entity.position.y,t=this.entity.box.width,e=this.entity.box.height;if(!!this.repeat||!this.played)return Kona.Canvas.ctx.drawImage(this.image,this.position.x,this.position.y,this.frames.width,this.frames.height,n,r,t,e),this.update()},e.prototype.reset=function(){return this.played=!0,this.triggerNext(),this.position.x=this.position.y=0},e}();var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Kona.Tile=function(e){function t(e){e==null&&(e={}),t.__super__.constructor.call(this,e),this.size=Kona.Tile.tileSize,this.box={width:this.size,height:this.size}}return __extends(t,e),t.tileSize=60,t.prototype.update=function(){},t}(Kona.Entity),Kona.BlankTile=function(e){function t(e){t.__super__.constructor.call(this,e),this.solid=!1}return __extends(t,e),t.prototype.update=function(){},t.prototype.draw=function(){},t}(Kona.Tile);var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Kona.Collectable=function(e){function t(e){e==null&&(e={}),t.__super__.constructor.call(this,e),this.solid=!1,this.gravity=!1}return __extends(t,e),t.prototype.update=function(){var e,t,n,r,i;e=Kona.Collectors[this.group];if(e!=null){i=[];for(n=0,r=e.length;n<r;n++)t=e[n],this.intersecting(t)?(this.activate(t),i.push(this.destroy())):i.push(void 0);return i}},t.prototype.activate=function(){return fail("Implement activate() in a derived Collectable class")},t}(Kona.Entity),Kona.Collectors={add:function(e,t){return this[e]||(this[e]=[]),this[e].push(t)}},Kona.Keys={_handlers:{},_keycodes:{enter:13,"return":13,esc:27,escape:27,ctrl:17,control:17,left:37,up:38,right:39,down:40,shift:16,space:32},_names:{13:"enter",16:"shift",17:"ctrl",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},bind:function(e,t){var n,r;return e=e.replace(/\s/g,""),n=this._keycodes[e]||e.toUpperCase().charCodeAt(0),(r=this._handlers)[n]||(r[n]=[]),this._handlers[n].push(t)},dispatch:function(e){var t,n,r,i,s,o;n=this.eventKeyCode(e);if(this.reject(e)||this._handlers[n]==null)return;s=this._handlers[n],o=[];for(r=0,i=s.length;r<i;r++)t=s[r],t.call(e),o.push(!1);return o},reject:function(e){return _.contains(["INPUT","SELECT","TEXTAREA"],e.target.tagName)},keycodeName:function(e){return this._names[this.eventKeyCode(e)]},eventKeyCode:function(e){return e.which||e.keyCode}},Kona.ready(function(){return document.body.onkeydown=function(e){var t;t=Kona.Keys.keycodeName(e);if(Kona.Keys.keydown)return Kona.Keys.keydown(t)},document.body.onkeyup=function(e){var t;t=Kona.Keys.keycodeName(e);if(Kona.Keys.keyup)return Kona.Keys.keyup(t)},document.addEventListener("keydown",Kona.Keys.dispatch.bind(Kona.Keys),!1)}),Kona.Sounds={sounds:{},load:function(e){var t,n,r;e==null&&(e={}),r=[];for(t in e)n=e[t],r.push(this.sounds[t]=new Kona.Sound(n));return r},play:function(e){return this.sounds[e].play()}},Kona.Sound=function(){function e(e,t){var n,r,i,s,o,u,a,f,l,c=this;t==null&&(t={}),this.supported=Kona.Sound.isSupported();if(this.supported&&e!=null){f=Kona.Sound.defaults;for(n in f)i=f[n],t[n]=t[n]||i}this.el=document.createElement("audio");if(_.isArray(e))for(s=0,u=e.length;s<u;s++)r=e[s],this.addSource(this.el,r);else if(t.formats!=null&&t.formats.length){l=t.formats;for(i=o=0,a=l.length;o<a;i=++o)n=l[i],this.addSource(this.el,""+e+"."+n)}else this.addSource(this.el,e);t.autoplay===!0&&(this.el.autoplay="autoplay"),this.el.preload=t.preload===!0?"auto":"none",this.setVolume(t.volume),this.el.addEventListener("loadedmetadata",function(){return c.duration=c.el.duration})}return e.defaults={autoplay:!1,duration:5e3,formats:[],loop:!1,placeholder:"--",preload:"metadata",volume:100},e.types={mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",m4a:"audio/x-m4a"},e.testEl=document.createElement("audio"),e.isSupported=function(){return!!this.testEl.canPlayType},e.isOGGSupported=function(){return this.testEl.canPlayType('audio/ogg codecs="vorbis"')},e.isWAVSupported=function(){return this.testEl.canPlayType('audio/wav codecs="1"')},e.isMP3Supported=function(){return this.testEl.canPlayType('audio/mpeg codecs="mp3"')},e.isAACSupported=function(){return this.testEl.canPlayType("audio/x-m4a")||this.testEl.canPlayType("audio/aac")},e.supportedFormats=function(){var e;return e=function(e){return e===""?"yes":e},Kona.debug("Audio format compatability:"),Kona.debug("  OGG: "+e(this.isOGGSupported())),Kona.debug("  WAV: "+e(this.isWAVSupported())),Kona.debug("  MP3: "+e(this.isMP3Supported())),Kona.debug("  AAC: "+e(this.isAACSupported()))},e.prototype.getExt=function(e){return e.split(".").pop()},e.prototype.addSource=function(e,t){var n,r;return r=document.createElement("source"),r.src=t,n=this.getExt(t),Kona.Sound.types[n]!=null&&(r.type=Kona.Sound.types[n]),e.appendChild(r)},e.prototype.load=function(){return this.supported?this.el.load():this},e.prototype.play=function(){return this.supported?this.el.play():this},e.prototype.togglePlay=function(){return this.supported?(this.el.paused?this.el.play():this.el.pause(),this):this},e.prototype.pause=function(){return this.supported?this.el.pause():this},e.prototype.isPaused=function(){return this.supported?this.el.paused:null},e.prototype.stop=function(){return this.supported?(this.el.currentTime=this.el.duration,this.el.pause()):null},e.prototype.isEnded=function(){return this.supported?this.el.ended:null},e.prototype.getDuration=function(){return this.supported?this.duration:null},e.prototype.mute=function(){return this.supported?this.el.muted=!0:null},e.prototype.unmute=function(){return this.supported?this.el.muted=!1:null},e.prototype.isMuted=function(){return this.supported?this.el.muted:null},e.prototype.toggleMute=function(){return this.supported?this.el.muted=!this.el.muted:null},e.prototype.setVolume=function(e){return this.supported?(e<0&&(e=0),e>100&&(e=100),this.volume=e,this.el.volume=e/100,this):this},e.prototype.getVolume=function(){return this.supported?this.volume:null},e.prototype.increaseVolume=function(e){return e==null&&(e=1),this.setVolume(this.volume+e)},e.prototype.decreaseVolume=function(e){return e==null&&(e=1),this.setVolume(this.volume-e)},e.prototype.getTime=function(){var e;return this.supported?(e=Math.round(this.el.currentTime*100)/100,isNaN(e)?Kona.Sound.defaults.placeholder:e):null},e.prototype.getDuration=function(){return this.supported?this.el.duration:null},e}();var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Kona.Menu=function(e){function t(e){var n=this;e==null&&(e={}),t.__super__.constructor.call(this,e),this.fontSize=e.fontSize||"30px",this.font=e.font||"Times New Roman",this.textAlign=e.textAlign||"center",this.textColor=e.textColor||"white",this.selectedColor=e.selectedColor||"yellow",this.options=e.options,this.trigger=e.trigger,this.trigger!=null&&Kona.Keys.bind(this.trigger,function(){return Kona.Canvas.clear(),Kona.Scenes.setCurrent(n.name)})}return __extends(t,e),t.prototype.draw=function(){var e=this;return Kona.Canvas.safe(function(){var t,n,r,i,s,o;Kona.Canvas.ctx.font=""+e.fontSize+" "+e.font,Kona.Canvas.ctx.textAlign=e.textAlign,r=(Kona.Canvas.height-parseInt(e.fontSize)*_.size(e.options))/2,i=0,s=e.options,o=[];for(n in s)t=s[n],Kona.Canvas.ctx.fillStyle="red",Kona.Canvas.ctx.fillText(n,Kona.Canvas.width/2,r+i),o.push(i+=parseInt(e.fontSize)+20);return o})},t}(Kona.Scene);var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Kona.Weapon=function(e){function t(e){e==null&&(e={}),t.__super__.constructor.call(this,e),this.canFire=!0,this.recharge=e.recharge||300,this.projType=e.projType||null,this.projSound=e.sound||"",this.holder=e.holder||null}return __extends(t,e),t.prototype.activate=function(e){return this.holder=e,e.currentWeapon=this},t.prototype.fire=function(){var e,t,n,r,i=this;if(this.canFire)return t=this.holder.facing==="right"?1:-1,n=this.holder.facing==="right"?this.holder.right()+1:this.holder.left()-30,r=this.holder.top()+15,e=new this.projType({group:"projectiles",x:n,y:r,dx:t}),Kona.Scenes.currentScene.addEntity(e),this
.projSound!==""&&Kona.Sounds.play(this.projSound),this.canFire=!1,setTimeout(function(){return i.canFire=!0},this.recharge)},t}(Kona.Collectable),Kona.EnemyWeapon=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.randomTarget=function(){var e,t,n,r,i;t=[],i=this.targets;for(n=0,r=i.length;n<r;n++)e=i[n],t=t.concat(Kona.Scenes.currentScene.entities[e]);return _.shuffle(t)[0]},t.prototype.fire=function(){var e,t,n,r,i,s,o,u,a,f,l,c;u=this.randomTarget();if(this.holder.active()){l=Math.abs(this.holder.midx()-u.midx()),c=Math.abs(this.holder.midy()-u.midy()),a=this.holder.position.x>=u.midx(),f=this.holder.position.y>=u.midy(),e=Math.atan2(c,l)+(f?.5:0),i=1,n=i*Math.cos(e)*(a?-1:1),r=i*Math.sin(e)*(f?-1:1),s=a?this.holder.left()-20:this.holder.right()+20,o=this.holder.top()+25,t=new this.projType({group:"projectiles",x:s,y:o,dx:n,dy:r}),Kona.Scenes.currentScene.addEntity(t);if(this.projSound!=="")return Kona.Sounds.play(this.projSound)}},t}(Kona.Weapon);var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Kona.Projectile=function(e){function t(e){e==null&&(e={}),t.__super__.constructor.call(this,e),this.speed=e.speed||10}return __extends(t,e),t.prototype.update=function(){var e,n,r,i,s,o;t.__super__.update.call(this),this.position.x+=this.speed*this.direction.dx;if(this.leftCollisions()||this.rightCollisions()){o=this.neighborEntities();for(r in o){n=o[r];for(i=0,s=n.length;i<s;i++)e=n[i],(this.leftCollision(e)||this.rightCollision(e))&&e.solid&&(_.contains(this.destructibles,r)&&e.destroy(),this.destroy())}}if(this.position.x<0||this.position.x>Kona.Canvas.width)return this.destroy()},t}(Kona.Entity);